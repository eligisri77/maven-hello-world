name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Maven Build & Docker"]   # ðŸ‘ˆ must match build.yml name
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repo (to get helm/myapp folder)
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Set up kubectl (requires KUBECONFIG_DATA secret)
      - name: Set up kubectl
        run: |
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 --decode > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig

      # 3. Extract version from pom.xml
      - name: Extract version
        id: version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout --file myapp/pom.xml)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # 4. Update Chart.yaml appVersion
      - name: Update Chart.yaml appVersion
        run: |
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.version }}\"/" helm/Chart.yaml

      # 5. Update values.yaml image.tag
      - name: Update values.yaml image.tag
        run: |
          sed -i "s/^  tag:.*/  tag: \"${{ steps.version.outputs.version }}\"/" helm/values.yaml

      # 6. Deploy with Helm
      - name: Helm upgrade/install
        run: |
          helm upgrade --install myapp ./helm/myapp \
            --set image.repository=${{ secrets.DOCKER_USERNAME }}/myapp \
            --set image.tag=${{ steps.version.outputs.version }} \
            --set image.pullPolicy=Always

      # 7. Verify rollout
      - name: Verify rollout
        run: |
          kubectl rollout status deployment/myapp-myapp
