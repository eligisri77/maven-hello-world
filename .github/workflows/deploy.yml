name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Maven Build & Docker"]
    types:
      - completed

permissions:
  contents: write   # ðŸ‘ˆ allows pushing changes to the repo

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up kubectl
        run: |
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 --decode > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig

      - name: Extract version from pom.xml
        id: version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout --file myapp/pom.xml)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Update Chart.yaml appVersion
        run: |
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.version }}\"/" helm/Chart.yaml

      - name: Update values.yaml image.tag
        run: |
          sed -i "s/^  tag:.*/  tag: \"${{ steps.version.outputs.version }}\"/" helm/values.yaml

      - name: Commit updated Helm chart version
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add helm/Chart.yaml helm/values.yaml
          git commit -m "Update Helm chart version to ${{ steps.version.outputs.version }}"
          git push

      - name: Helm upgrade/install
        run: |
          helm upgrade --install myapp ./helm/myapp \
            --set image.repository=${{ secrets.DOCKER_USERNAME }}/myapp \
            --set image.tag=${{ steps.version.outputs.version }} \
            --set image.pullPolicy=Always

      - name: Verify rollout
        run: |
